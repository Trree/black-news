{% extends "base.html" %}

{% block title %}数据源管理 - 黑天鹅新闻监测系统{% endblock %}

{% block content %}
<!-- 页面标题和描述 -->
<div style="margin-bottom: 2rem;">
    <h1 style="color: #2c3e50; margin-bottom: 0.5rem;">数据源管理</h1>
    <p style="color: #7f8c8d;">管理和监控新闻数据源的状态和配置</p>
</div>

<!-- 统计信息 -->
<div class="stats-cards" id="sourcesStats" style="margin-bottom: 2rem;">
    <div class="stat-card">
        <h3>总数据源</h3>
        <div class="value" id="totalSources">0</div>
    </div>
    <div class="stat-card">
        <h3>活跃数据源</h3>
        <div class="value" id="activeSources">0</div>
    </div>
    <div class="stat-card">
        <h3>今日更新</h3>
        <div class="value" id="todayUpdates">0</div>
    </div>
    <div class="stat-card">
        <h3>成功率</h3>
        <div class="value small" id="successRate">0%</div>
    </div>
</div>

<!-- 数据源列表 -->
<section class="sources-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="color: #2c3e50;">数据源列表</h2>
        <button id="addSourceBtn" class="search-button">添加数据源</button>
    </div>
    
    <!-- 加载指示器 -->
    <div class="loading" id="loadingIndicator" style="display: none;">
        <div class="loading-spinner"></div>
        <p>加载数据源...</p>
    </div>
    
    <!-- 数据源表格 -->
    <div id="sourcesContainer">
        <!-- 通过JavaScript动态加载数据源 -->
    </div>
</section>

<!-- 数据源监控 -->
<section class="monitoring-section" style="margin-top: 3rem;">
    <h2 style="color: #2c3e50; margin-bottom: 1rem;">数据源监控</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
        <!-- 响应时间图表 -->
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            <h3 style="color: #2c3e50; margin-bottom: 1rem;">响应时间监控</h3>
            <div id="responseTimeChart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: #7f8c8d;">
                图表加载中...
            </div>
        </div>
        
        <!-- 成功率图表 -->
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            <h3 style="color: #2c3e50; margin-bottom: 1rem;">成功率统计</h3>
            <div id="successRateChart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: #7f8c8d;">
                图表加载中...
            </div>
        </div>
    </div>
</section>

<!-- 操作日志 -->
<section class="logs-section" style="margin-top: 3rem;">
    <h2 style="color: #2c3e50; margin-bottom: 1rem;">最近操作日志</h2>
    
    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <div id="logsContainer">
            <!-- 通过JavaScript动态加载日志 -->
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
// 数据源页面特定的JavaScript逻辑
document.addEventListener('DOMContentLoaded', function() {
    // 绑定添加数据源按钮事件
    document.getElementById('addSourceBtn').addEventListener('click', showAddSourceModal);
    
    // 加载数据源统计
    loadSourcesStats();
    
    // 加载数据源列表
    loadSources();
    
    // 加载监控数据
    loadMonitoringData();
    
    // 加载操作日志
    loadLogs();
});

/**
 * 加载数据源统计
 */
async function loadSourcesStats() {
    try {
        const response = await fetch('/api/stats/sources');
        const stats = await response.json();
        
        updateSourcesStats(stats);
    } catch (error) {
        console.error('加载数据源统计失败:', error);
    }
}

/**
 * 更新数据源统计显示
 */
function updateSourcesStats(stats) {
    const totalSources = document.getElementById('totalSources');
    const activeSources = document.getElementById('activeSources');
    const todayUpdates = document.getElementById('todayUpdates');
    const successRate = document.getElementById('successRate');
    
    if (totalSources) totalSources.textContent = stats.total_sources || 0;
    if (activeSources) activeSources.textContent = stats.active_sources || 0;
    if (todayUpdates) todayUpdates.textContent = stats.today_updates || 0;
    if (successRate) successRate.textContent = `${Math.round(stats.success_rate || 0)}%`;
}

/**
 * 加载数据源列表
 */
async function loadSources() {
    const container = document.getElementById('sourcesContainer');
    const loadingElement = document.getElementById('loadingIndicator');
    
    if (loadingElement) {
        loadingElement.style.display = 'block';
    }
    if (container) {
        container.innerHTML = '';
    }
    
    try {
        const response = await fetch('/api/sources');
        const sources = await response.json();
        
        updateSourcesDisplay(sources);
        
    } catch (error) {
        console.error('加载数据源失败:', error);
        showError('加载数据源失败');
    } finally {
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
    }
}

/**
 * 更新数据源显示
 */
function updateSourcesDisplay(sources) {
    const container = document.getElementById('sourcesContainer');
    if (!container) return;
    
    if (!sources || sources.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #7f8c8d;">
                <h3>暂无数据源</h3>
                <p>请添加数据源以开始监控新闻</p>
            </div>
        `;
        return;
    }
    
    const sourcesHTML = createSourcesTable(sources);
    container.innerHTML = sourcesHTML;
}

/**
 * 创建数据源表格HTML
 */
function createSourcesTable(sources) {
    return `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <thead>
                    <tr style="background: #34495e; color: white;">
                        <th style="padding: 1rem; text-align: left;">名称</th>
                        <th style="padding: 1rem; text-align: left;">URL</th>
                        <th style="padding: 1rem; text-align: center;">状态</th>
                        <th style="padding: 1rem; text-align: center;">最后更新</th>
                        <th style="padding: 1rem; text-align: center;">成功率</th>
                        <th style="padding: 1rem; text-align: center;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${sources.map(source => createSourceRow(source)).join('')}
                </tbody>
            </table>
        </div>
    `;
}

/**
 * 创建数据源行HTML
 */
function createSourceRow(source) {
    const lastUpdate = source.last_fetch ? new Date(source.last_fetch).toLocaleString('zh-CN') : '从未';
    const status = source.is_active ? '活跃' : '禁用';
    const statusColor = source.is_active ? '#27ae60' : '#e74c3c';
    const successRate = Math.round((source.success_count / (source.success_count + source.failure_count)) * 100) || 0;
    const successRateColor = successRate >= 80 ? '#27ae60' : successRate >= 60 ? '#f39c12' : '#e74c3c';
    
    return `
        <tr style="border-bottom: 1px solid #eee;">
            <td style="padding: 1rem;">
                <strong>${escapeHtml(source.name)}</strong>
                ${source.category ? `<br><span style="color: #7f8c8d; font-size: 0.9rem;">${escapeHtml(source.category)}</span>` : ''}
            </td>
            <td style="padding: 1rem;">
                <a href="${source.url}" target="_blank" style="color: #3498db; text-decoration: none; word-break: break-all;">
                    ${escapeHtml(source.url)}
                </a>
            </td>
            <td style="padding: 1rem; text-align: center;">
                <span style="color: ${statusColor}; font-weight: 600;">${status}</span>
            </td>
            <td style="padding: 1rem; text-align: center; color: #7f8c8d;">
                ${lastUpdate}
            </td>
            <td style="padding: 1rem; text-align: center;">
                <span style="color: ${successRateColor}; font-weight: 600;">${successRate}%</span>
            </td>
            <td style="padding: 1rem; text-align: center;">
                <button class="filter-button test-source-btn" data-source-id="${source.id}" style="margin-right: 0.5rem;">测试</button>
                <button class="filter-button edit-source-btn" data-source-id="${source.id}" style="margin-right: 0.5rem;">编辑</button>
                <button class="filter-button toggle-source-btn" data-source-id="${source.id}" data-active="${source.is_active}">
                    ${source.is_active ? '禁用' : '启用'}
                </button>
            </td>
        </tr>
    `;
}

/**
 * 显示添加数据源模态框
 */
function showAddSourceModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    modal.innerHTML = `
        <div class="modal-content" style="
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        ">
            <button class="close-button" style="
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #7f8c8d;
            ">&times;</button>
            
            <h2 style="margin-bottom: 1.5rem; color: #2c3e50;">添加数据源</h2>
            
            <form id="addSourceForm">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #7f8c8d; font-weight: 500;">数据源名称</label>
                    <input type="text" name="name" class="search-input" style="width: 100%;" required placeholder="例如：新华网">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #7f8c8d; font-weight: 500;">RSS URL</label>
                    <input type="url" name="url" class="search-input" style="width: 100%;" required placeholder="https://example.com/rss">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #7f8c8d; font-weight: 500;">分类</label>
                    <select name="category" class="search-input" style="width: 100%;">
                        <option value="news">新闻</option>
                        <option value="finance">财经</option>
                        <option value="technology">科技</option>
                        <option value="politics">政治</option>
                        <option value="sports">体育</option>
                        <option value="entertainment">娱乐</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; color: #7f8c8d;">
                        <input type="checkbox" name="is_active" checked style="margin-right: 0.5rem;">
                        启用数据源
                    </label>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="search-button" style="flex: 1;">添加</button>
                    <button type="button" class="filter-button close-modal-btn" style="flex: 1;">取消</button>
                </div>
            </form>
        </div>
    `;
    
    // 关闭按钮事件
    const closeButton = modal.querySelector('.close-button');
    const closeModalBtn = modal.querySelector('.close-modal-btn');
    
    closeButton.addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    closeModalBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    // 点击背景关闭
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
    
    // 表单提交事件
    const form = modal.querySelector('#addSourceForm');
    form.addEventListener('submit', handleAddSource);
    
    document.body.appendChild(modal);
}

/**
 * 处理添加数据源
 */
async function handleAddSource(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    const data = {
        name: formData.get('name'),
        url: formData.get('url'),
        category: formData.get('category'),
        is_active: formData.get('is_active') === 'on'
    };
    
    try {
        const response = await fetch('/api/sources', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showSuccess('数据源添加成功');
            document.body.removeChild(document.querySelector('.modal'));
            loadSources();
            loadSourcesStats();
        } else {
            throw new Error('添加失败');
        }
    } catch (error) {
        console.error('添加数据源失败:', error);
        showError('添加数据源失败');
    }
}

/**
 * 测试数据源
 */
async function testSource(sourceId) {
    try {
        const response = await fetch(`/api/sources/${sourceId}/test`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(`数据源测试成功: ${result.message}`);
        } else {
            showError(`数据源测试失败: ${result.message}`);
        }
    } catch (error) {
        console.error('测试数据源失败:', error);
        showError('测试数据源失败');
    }
}

/**
 * 切换数据源状态
 */
async function toggleSource(sourceId, isActive) {
    try {
        const response = await fetch(`/api/sources/${sourceId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                is_active: !isActive
            })
        });
        
        if (response.ok) {
            showSuccess(`数据源${!isActive ? '启用' : '禁用'}成功`);
            loadSources();
            loadSourcesStats();
        } else {
            throw new Error('操作失败');
        }
    } catch (error) {
        console.error('切换数据源状态失败:', error);
        showError('切换数据源状态失败');
    }
}

/**
 * 加载监控数据
 */
async function loadMonitoringData() {
    // 这里可以集成图表库如Chart.js来显示监控数据
    // 目前先显示占位文本
    setTimeout(() => {
        document.getElementById('responseTimeChart').innerHTML = '<p>平均响应时间: 1.2秒</p>';
        document.getElementById('successRateChart').innerHTML = '<p>总体成功率: 85%</p>';
    }, 1000);
}

/**
 * 加载操作日志
 */
async function loadLogs() {
    try {
        const response = await fetch('/api/logs/sources');
        const logs = await response.json();
        
        updateLogsDisplay(logs);
    } catch (error) {
        console.error('加载日志失败:', error);
    }
}

/**
 * 更新日志显示
 */
function updateLogsDisplay(logs) {
    const container = document.getElementById('logsContainer');
    if (!container) return;
    
    if (!logs || logs.length === 0) {
        container.innerHTML = '<p style="color: #7f8c8d; text-align: center;">暂无操作日志</p>';
        return;
    }
    
    const logsHTML = logs.map(log => `
        <div style="padding: 0.5rem 0; border-bottom: 1px solid #eee;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 500;">${escapeHtml(log.message)}</span>
                <span style="color: #7f8c8d; font-size: 0.9rem;">${new Date(log.timestamp).toLocaleString('zh-CN')}</span>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = logsHTML;
}

// 绑定动态生成的按钮事件
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('test-source-btn')) {
        const sourceId = e.target.dataset.sourceId;
        testSource(sourceId);
    }
    
    if (e.target.classList.contains('toggle-source-btn')) {
        const sourceId = e.target.dataset.sourceId;
        const isActive = e.target.dataset.active === 'true';
        toggleSource(sourceId, isActive);
    }
    
    if (e.target.classList.contains('edit-source-btn')) {
        // 编辑数据源功能（可以扩展）
        showError('编辑功能开发中');
    }
});
</script>

<style>
.modal {
    font-family: inherit;
}

.modal-content h2 {
    font-size: 1.5rem;
}

.modal-content input,
.modal-content select {
    font-size: 1rem;
    padding: 0.75rem;
}

.modal-content button {
    font-size: 1rem;
    padding: 0.75rem;
}

table {
    font-size: 0.9rem;
}

table th {
    font-weight: 600;
}

table tr:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}